name: Release Build

on:
  push:
    branches:
      - 'releases/*'
      - 'ci-cd/*'

jobs:
  print_branch_tag:
    runs-on: ubuntu-latest
    name: A job to print branch tag
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - uses: nimblehq/branch-tag-action@v1
        id: extract

      # Use the output/env from the `extract` step
      - name: Print the values
        run: |
          echo "The branch tag is ${{ steps.extract.outputs.branch_tag }}"
          echo "or ${{ env.BRANCH_TAG }}"
      - name: Determine version from string
        id: determine_version
        run: |
          my_string=${{ steps.extract.outputs.branch_tag }}
          VERSION=$(echo "$my_string" | cut -d'-' -f3)
          echo "::set-output name=VERSION::$VERSION"ERSION=$(echo "$my_string" | cut -d'-' -f3)
          echo "::set-output name=VERSION::$VERSION"
          
      - name: Build and push Docker image
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
          VERSION: ${{ steps.determine_version.outputs.VERSION }}
        run: |
          docker build -t $DOCKER_USERNAME/skypilot:${{ env.VERSION }} .
          docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
          docker push $DOCKER_USERNAME/skypilot:${{ env.VERSION }}
