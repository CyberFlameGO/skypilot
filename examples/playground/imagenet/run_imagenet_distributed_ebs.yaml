resources:
  cloud: aws
  resources: V100

num_nodes: 2

file_mounts:
  /imagenet:
    name: sky-imagenet-data
    mode: MOUNT

setup: |
  git clone https://github.com/Michaelvll/examples.git
  cd ./examples/imagenet
  conda create -n imagenet python=3.9 -y
  conda activate imagenet
  conda install pytorch torchvision torchaudio cudatoolkit=11.3 -c pytorch -y
  pip install -r requirements.txt
  pip install wandb
  wandb login <your-wandb-token>

run: |
  if [ ! -d ~/imagenet ]; then
    unzip /imagenet/imagenet2012.zip -d ~
  fi

  conda activate imagenet
  master_addr=`echo "$SKY_NODE_IPS" | head -n1`
  world_size=`echo "$SKY_NODE_IPS" | wc -l`

  mkdir -p /imagenet/checkpoints/ILSRC2012/imagenet/resnet18-ebs-node${world_size}

  cd ./examples/imagenet
  python main.py -a resnet18 \
    --save-path /imagenet/checkpoints/ILSRC2012/imagenet/resnet18 \
    --resume /imagenet/checkpoints/ILSRC2012/imagenet/resnet18 \
    --dist-url 'tcp://${master_addr}:12344 --dist-backend 'nccl' \
    --multiprocessing-distributed --world-size ${world_size} \
    --rank ${SKY_NODE_RANK} \
    ~/imagenet

