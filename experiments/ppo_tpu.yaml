name: tpuvm_ppo

resources:
  accelerators: tpu-v2-8
  accelerator_args:
    runtime_version: tpu-vm-base
    tpu_vm: True

# The setup command.  Will be run under the working directory.
setup: |
  git clone git@github.com:WoosukKwon/skypilot-experiments.git flax

  conda activate flax
  if [ $? -eq 0 ]; then
    echo 'conda env exists'
  else
    conda create -n flax python=3.8 -y
    conda activate flax
    # Make sure to install TPU related packages in a conda env to avoid package conflicts.
    
    pip install --upgrade clu
    sudo apt install cmake libgl1-mesa-dev -y
    cd flax/examples/ppo
    pip install -r requirements.txt
    pip install "jax[tpu]>=0.2.16,<=0.3.4" -f https://storage.googleapis.com/jax-releases/libtpu_releases.html

    pip install "git+https://github.com/skypilot-org/skypilot.git#egg=sky-callback&subdirectory=sky/callbacks/"
  fi
# The command to run.  Will be run under the working directory.
run: |
  conda activate flax
  cd flax/examples/ppo
  python ppo_main.py
